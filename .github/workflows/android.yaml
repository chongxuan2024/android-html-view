name: Paradise HTML Viewer CI/CD

on:
  push:
    tags:
      - "v*" # Trigger when pushing tags starting with v, e.g. v1.0.0
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Grant execute permission for scripts
        run: |
          chmod +x gradlew
          chmod +x scripts/download_resources.sh
        working-directory: ./

      - name: Create local.properties
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
        working-directory: ./
        
      - name: Download game resources
        run: |
          echo "ğŸš€ å¼€å§‹ä¸‹è½½æ¸¸æˆèµ„æº..."
          ./scripts/download_resources.sh
        working-directory: ./
        
      - name: Verify downloaded resources
        run: |
          echo "ğŸ“‹ éªŒè¯ä¸‹è½½çš„èµ„æº..."
          ls -la app/src/main/assets/
          echo "ğŸ“„ apps.jsonå†…å®¹:"
          cat app/src/main/assets/apps.json
          echo "ğŸ–¼ï¸ å›¾ç‰‡æ–‡ä»¶:"
          ls -la app/src/main/assets/images/ || echo "å›¾ç‰‡ç›®å½•ä¸å­˜åœ¨"
          echo "ğŸ“„ HTMLæ–‡ä»¶:"
          ls -la app/src/main/assets/html/ || echo "HTMLç›®å½•ä¸å­˜åœ¨"

      - name: Build Debug APK
        run: |
          echo "ğŸ”¨ æ„å»ºDebug APK..."
          ./gradlew app:assembleDebug --stacktrace
        working-directory: ./

      - name: Build Release APK (unsigned)
        run: |
          echo "ğŸ”¨ æ„å»ºRelease APK (æœªç­¾å)..."
          ./gradlew app:assembleRelease --stacktrace
        working-directory: ./

      - name: Upload Debug APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: paradise-html-debug-apk
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: Upload Release APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: paradise-html-release-unsigned-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90
          
      - name: Generate build summary
        run: |
          echo "## ğŸ‰ æ„å»ºå®Œæˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± APKä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»å‹ | æ–‡ä»¶ | å¤§å° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -f app/build/outputs/apk/debug/*.apk ]; then
            DEBUG_APK=$(ls app/build/outputs/apk/debug/*.apk)
            DEBUG_SIZE=$(du -h "$DEBUG_APK" | cut -f1)
            echo "| Debug | $(basename "$DEBUG_APK") | $DEBUG_SIZE |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f app/build/outputs/apk/release/*.apk ]; then
            RELEASE_APK=$(ls app/build/outputs/apk/release/*.apk)
            RELEASE_SIZE=$(du -h "$RELEASE_APK" | cut -f1)
            echo "| Release (æœªç­¾å) | $(basename "$RELEASE_APK") | $RELEASE_SIZE |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ğŸ® æ¸¸æˆèµ„æº" >> $GITHUB_STEP_SUMMARY
          GAME_COUNT=$(cat app/src/main/assets/apps.json | python3 -c "import sys, json; print(len(json.load(sys.stdin)))")
          echo "- æˆåŠŸä¸‹è½½ **$GAME_COUNT** ä¸ªæ¸¸æˆ" >> $GITHUB_STEP_SUMMARY
          echo "- èµ„æºæ¥æº: [APIæ¥å£](http://47.112.166.202:8080/userapi/allGame2)" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“‚ èµ„æºç»“æ„" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "app/src/main/assets/" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ apps.json" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ images/" >> $GITHUB_STEP_SUMMARY
          ls app/src/main/assets/images/ | sed 's/^/â”‚   â”œâ”€â”€ /' >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€ html/" >> $GITHUB_STEP_SUMMARY
          ls app/src/main/assets/html/ | sed 's/^/    â”œâ”€â”€ /' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "### âš ï¸ é‡è¦è¯´æ˜" >> $GITHUB_STEP_SUMMARY
          echo "- **Debug APK**: ç”¨äºå¼€å‘å’Œæµ‹è¯•ï¼ŒåŒ…å«è°ƒè¯•ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Release APK**: æœªç­¾åç‰ˆæœ¬ï¼Œéœ€è¦æ‰‹åŠ¨ç­¾ååæ‰èƒ½å®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo "- **JavaScriptæ¥å£**: å·²é›†æˆå®Œæ•´çš„æ¸¸æˆäº¤äº’æ¥å£" >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ github.token }}
          tag_name: ${{ github.ref_name }}
          name: "Paradise HTML Viewer ${{ github.ref_name }}"
          body: |
            ## ğŸŒ´ Paradise HTML Viewer Release ${{ github.ref_name }}
            
            ### ğŸ–ï¸ What's New
            - ğŸ® **è‡ªåŠ¨æ¸¸æˆèµ„æºä¸‹è½½**: æ¯æ¬¡æ„å»ºè‡ªåŠ¨è·å–æœ€æ–°æ¸¸æˆå†…å®¹
            - ğŸŒº **çƒ­å¸¦å¤©å ‚ä¸»é¢˜**: ç¾ä¸½çš„æµ·æ»©åº¦å‡æ‘ç•Œé¢è®¾è®¡
            - ğŸ’– **æ”¶è—åŠŸèƒ½**: æŒä¹…åŒ–æ”¶è—çŠ¶æ€ï¼Œæ”¯æŒåº”ç”¨å‡çº§
            - ğŸ„â€â™‚ï¸ **å†²æµªä½“éªŒ**: ç½‘ä¸Šå†²æµªçš„å®Œç¾ä½“éªŒ
            - ğŸ”„ **æ™ºèƒ½æ’åº**: æ”¶è—çš„åº”ç”¨ä¼˜å…ˆæ˜¾ç¤º
            - ğŸ”Œ **JavaScriptæ¥å£**: å®Œæ•´çš„æ¸¸æˆäº¤äº’API
            
            ### ğŸ“± Download
            - **Debug APK**: å¼€å‘æµ‹è¯•ç‰ˆæœ¬ï¼ŒåŒ…å«è°ƒè¯•ä¿¡æ¯
            - **Release APK**: æœªç­¾åç‰ˆæœ¬ï¼Œéœ€è¦æ‰‹åŠ¨ç­¾ååå®‰è£…
            
            ### ğŸ® æ¸¸æˆå†…å®¹
            æœ¬ç‰ˆæœ¬åŒ…å«ä»¥ä¸‹HTMLæ¸¸æˆï¼š
            - ğŸ”¤ **è®¤è¯†å¤šéŸ³å­—** (æ‹¼éŸ³) - è°¢é›¨è²
            - ğŸ¯ **æˆè¯­æ¶ˆæ¶ˆä¹** (æˆè¯­) - é©¬æ–¹æ³½  
            - ğŸŒ¿ **äºŒåå››èŠ‚æ°”è‡ªç„¶æ¢ç´¢** (å›½å­¦) - ä½•è¿œçš“
            - ğŸ“š **å››å¤§åè‘—** (æ–‡å­¦) - ä½™æ€æˆ
            - ğŸ“ **ç»å…¸è¯—è¯** (è¯—è¯) - ä½•è¿œçš“
            - ğŸ² **æˆè¯­çŒœä¸€çŒœ** (æˆè¯­) - ç‹å­é“­
            
            ### ğŸ”Œ JavaScriptæ¥å£
            ä¸ºHTMLæ¸¸æˆæä¾›å®Œæ•´çš„äº¤äº’æ¥å£ï¼š
            - `ParadiseGame.submitScore(score)` - æäº¤æ¸¸æˆåˆ†æ•°
            - `ParadiseGame.getHighScore()` - è·å–æœ€é«˜åˆ†
            - `ParadiseGame.getPlayCount()` - è·å–æ¸¸ç©æ¬¡æ•°
            - `ParadiseGame.gameStart()` - æ¸¸æˆå¼€å§‹é€šçŸ¥
            - `ParadiseGame.gameEnd(score, time)` - æ¸¸æˆç»“æŸé€šçŸ¥
            - `ParadiseGame.showMessage(msg)` - æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            
            ### ğŸŒº æ ¸å¿ƒç‰¹æ€§
            - ğŸï¸ HTMLåº”ç”¨æµè§ˆå™¨ï¼Œçƒ­å¸¦å¤©å ‚ä¸»é¢˜
            - ğŸ’¾ æ”¶è—åº”ç”¨ç®¡ç†ï¼Œæ•°æ®æŒä¹…åŒ–ä¿æŠ¤
            - ğŸ¨ ç¾ä¸½çš„æµ·æ»©åº¦å‡æ‘UIè®¾è®¡
            - ğŸ”„ åº”ç”¨é—´æµç•…å¯¼èˆª
            - ğŸŒ è‡ªåŠ¨èµ„æºä¸‹è½½å’Œæ›´æ–°
            - ğŸ“Š å®Œæ•´çš„ç”¨æˆ·ç»Ÿè®¡ç³»ç»Ÿ
            
            ### âš ï¸ å®‰è£…è¯´æ˜
            - **Debug APK**: å¯ç›´æ¥å®‰è£…ï¼Œç”¨äºæµ‹è¯•
            - **Release APK**: æœªç­¾åï¼Œéœ€è¦å…ˆç­¾åæˆ–å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨
            
            äº«å—æ‚¨çš„æ•°å­—å¤©å ‚ï¼ğŸï¸ğŸŒºâœ¨
          draft: false
          prerelease: false
          files: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/release/*.apk

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Grant execute permission for scripts
        run: |
          chmod +x gradlew
          chmod +x scripts/download_resources.sh
        working-directory: ./

      - name: Download game resources for testing
        run: |
          echo "ğŸš€ ä¸ºæµ‹è¯•ä¸‹è½½æ¸¸æˆèµ„æº..."
          ./scripts/download_resources.sh
        working-directory: ./

      - name: Run unit tests
        run: ./gradlew app:testDebugUnitTest
        working-directory: ./

      - name: Generate test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: app/build/reports/tests/
          retention-days: 30
