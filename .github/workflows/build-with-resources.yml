name: Build Android APK with Resource Download

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make scripts executable
      run: |
        chmod +x scripts/download_resources.sh
        chmod +x gradlew
        
    - name: Download game resources
      run: |
        echo "ðŸš€ å¼€å§‹ä¸‹è½½æ¸¸æˆèµ„æº..."
        ./scripts/download_resources.sh
        
    - name: Verify downloaded resources
      run: |
        echo "ðŸ“‹ éªŒè¯ä¸‹è½½çš„èµ„æº..."
        ls -la app/src/main/assets/
        echo "ðŸ“„ apps.jsonå†…å®¹:"
        cat app/src/main/assets/apps.json
        echo "ðŸ–¼ï¸ å›¾ç‰‡æ–‡ä»¶:"
        ls -la app/src/main/assets/images/ || echo "å›¾ç‰‡ç›®å½•ä¸å­˜åœ¨"
        echo "ðŸ“„ HTMLæ–‡ä»¶:"
        ls -la app/src/main/assets/html/ || echo "HTMLç›®å½•ä¸å­˜åœ¨"
        
    - name: Build Debug APK
      run: |
        echo "ðŸ”¨ æž„å»ºDebug APK..."
        ./gradlew assembleDebug --stacktrace
        
    - name: Build Release APK
      run: |
        echo "ðŸ”¨ æž„å»ºRelease APK..."
        ./gradlew assembleRelease --stacktrace
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v3
      with:
        name: paradise-html-debug-apk
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v3
      with:
        name: paradise-html-release-apk
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30
        
    - name: Generate build summary
      run: |
        echo "## ðŸŽ‰ æž„å»ºå®Œæˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± APKä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "| ç±»åž‹ | æ–‡ä»¶ | å¤§å° |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        
        if [ -f app/build/outputs/apk/debug/*.apk ]; then
          DEBUG_APK=$(ls app/build/outputs/apk/debug/*.apk)
          DEBUG_SIZE=$(du -h "$DEBUG_APK" | cut -f1)
          echo "| Debug | $(basename "$DEBUG_APK") | $DEBUG_SIZE |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f app/build/outputs/apk/release/*.apk ]; then
          RELEASE_APK=$(ls app/build/outputs/apk/release/*.apk)
          RELEASE_SIZE=$(du -h "$RELEASE_APK" | cut -f1)
          echo "| Release | $(basename "$RELEASE_APK") | $RELEASE_SIZE |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ðŸŽ® æ¸¸æˆèµ„æº" >> $GITHUB_STEP_SUMMARY
        GAME_COUNT=$(cat app/src/main/assets/apps.json | python3 -c "import sys, json; print(len(json.load(sys.stdin)))")
        echo "- æˆåŠŸä¸‹è½½ **$GAME_COUNT** ä¸ªæ¸¸æˆ" >> $GITHUB_STEP_SUMMARY
        echo "- èµ„æºæ¥æº: [APIæŽ¥å£](http://47.112.166.202:8080/userapi/allGame2)" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“‚ èµ„æºç»“æž„" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "app/src/main/assets/" >> $GITHUB_STEP_SUMMARY
        echo "â”œâ”€â”€ apps.json" >> $GITHUB_STEP_SUMMARY
        echo "â”œâ”€â”€ images/" >> $GITHUB_STEP_SUMMARY
        ls app/src/main/assets/images/ | sed 's/^/â”‚   â”œâ”€â”€ /' >> $GITHUB_STEP_SUMMARY
        echo "â””â”€â”€ html/" >> $GITHUB_STEP_SUMMARY
        ls app/src/main/assets/html/ | sed 's/^/    â”œâ”€â”€ /' >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
